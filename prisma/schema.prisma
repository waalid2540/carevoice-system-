// CareVoice - Multi-tenant SaaS for Audio Announcements
// Tables prefixed with cv_ to avoid conflicts in shared database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum CvUserRole {
  OWNER
  ADMIN
  STAFF

  @@map("cv_user_role")
}

enum CvSubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED

  @@map("cv_subscription_status")
}

enum CvAnnouncementType {
  TTS
  MP3

  @@map("cv_announcement_type")
}

enum CvDeviceStatus {
  PENDING
  PAIRED
  OFFLINE

  @@map("cv_device_status")
}

enum CvPlayStatus {
  SCHEDULED
  PLAYED
  SKIPPED
  FAILED

  @@map("cv_play_status")
}

// ==================== MODELS ====================

model Organization {
  id                   String                @id @default(cuid())
  name                 String
  timezone             String                @default("America/New_York")
  subscriptionStatus   CvSubscriptionStatus  @default(TRIAL)
  stripeCustomerId     String?               @unique
  stripeSubscriptionId String?
  trialEndsAt          DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  // Relations
  users               User[]
  rooms               Room[]
  devices             Device[]
  announcements       Announcement[]
  schedules           Schedule[]
  emergencyBroadcasts EmergencyBroadcast[]
  playLogs            PlayLog[]
  auditLogs           AuditLog[]

  @@map("cv_organizations")
  @@index([stripeCustomerId])
}

model User {
  id             String       @id @default(cuid())
  clerkId        String       @unique
  email          String
  name           String?
  role           CvUserRole   @default(STAFF)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("cv_users")
  @@index([organizationId])
  @@index([clerkId])
  @@index([email])
}

model Room {
  id             String       @id @default(cuid())
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  devices       Device[]
  scheduleItems ScheduleItem[]
  playLogs      PlayLog[]

  @@map("cv_rooms")
  @@index([organizationId])
}

model Device {
  id               String         @id @default(cuid())
  name             String
  roomId           String?
  room             Room?          @relation(fields: [roomId], references: [id], onDelete: SetNull)
  organizationId   String
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  pairingCode      String?        @unique
  pairingExpiresAt DateTime?
  lastSeenAt       DateTime?
  status           CvDeviceStatus @default(PENDING)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  playLogs PlayLog[]

  @@map("cv_devices")
  @@index([organizationId])
  @@index([organizationId, roomId])
  @@index([pairingCode])
  @@index([status])
}

model Announcement {
  id             String             @id @default(cuid())
  title          String
  type           CvAnnouncementType
  text           String?
  audioUrl       String?
  language       String             @default("en-US")
  voice          String?
  organizationId String
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relations
  scheduleItems       ScheduleItem[]
  emergencyBroadcasts EmergencyBroadcast[]
  playLogs            PlayLog[]

  @@map("cv_announcements")
  @@index([organizationId])
  @@index([organizationId, type])
}

model Schedule {
  id             String       @id @default(cuid())
  name           String
  active         Boolean      @default(true)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  items ScheduleItem[]

  @@map("cv_schedules")
  @@index([organizationId])
  @@index([organizationId, active])
}

model ScheduleItem {
  id             String       @id @default(cuid())
  scheduleId     String
  schedule       Schedule     @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  roomId         String?
  room           Room?        @relation(fields: [roomId], references: [id], onDelete: SetNull)
  timeOfDay      String
  daysOfWeek     Int[]
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  enabled        Boolean      @default(true)
  order          Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("cv_schedule_items")
  @@index([scheduleId])
  @@index([scheduleId, timeOfDay])
  @@index([roomId])
  @@index([announcementId])
}

model EmergencyBroadcast {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  active         Boolean      @default(true)
  expiresAt      DateTime?
  createdAt      DateTime     @default(now())

  @@map("cv_emergency_broadcasts")
  @@index([organizationId])
  @@index([organizationId, active])
  @@index([expiresAt])
}

model PlayLog {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  roomId         String?
  room           Room?         @relation(fields: [roomId], references: [id], onDelete: SetNull)
  deviceId       String?
  device         Device?       @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  announcementId String?
  announcement   Announcement? @relation(fields: [announcementId], references: [id], onDelete: SetNull)
  scheduledAt    DateTime
  playedAt       DateTime?
  status         CvPlayStatus  @default(SCHEDULED)
  createdAt      DateTime      @default(now())

  @@map("cv_play_logs")
  @@index([organizationId])
  @@index([organizationId, scheduledAt])
  @@index([organizationId, deviceId])
  @@index([deviceId, scheduledAt])
  @@index([announcementId])
}

model AuditLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  action         String
  entityType     String
  entityId       String?
  oldValue       Json?
  newValue       Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime     @default(now())

  @@map("cv_audit_logs")
  @@index([organizationId])
  @@index([organizationId, createdAt])
  @@index([entityType, entityId])
}
